---
title: 配置外部 PostgreSQL 数据库
slug: /configuration-custom-database
---
Langflow 的默认数据库是 [SQLite](https://www.sqlite.org/docs.html)，但您可以配置 Langflow 使用 PostgreSQL 代替。

本指南将带您了解如何通过将默认的 SQLite 连接字符串 `sqlite:///./langflow.db` 替换为 PostgreSQL 来为 Langflow 设置外部数据库，既适用于本地环境也适用于容器化环境。

在此配置中，来自 Langflow 的所有结构化应用程序数据（包括流程、消息历史和日志）都由 PostgreSQL 管理。
由于 PostgreSQL 对并发用户、高级数据完整性功能和可扩展性的强大支持，它更适合生产环境。
通过使用 PostgreSQL 作为数据库，Langflow 可以更高效地处理多个用户和更大的工作负载。

## 先决条件

- [安装和启动 Langflow](/get-started-installation)
- 创建一个 [PostgreSQL](https://www.pgadmin.org/download/) 数据库

## 将 Langflow 连接到本地 PostgreSQL 数据库

1. 如果 Langflow 正在运行，请使用 <kbd>Ctrl+C</kbd> 停止 Langflow。

2. 找到您的 PostgreSQL 数据库的连接字符串，格式为 `postgresql://user:password@host:port/dbname`。

    连接字符串中的主机名取决于您如何运行 PostgreSQL：

    - 如果您在机器上直接运行 PostgreSQL，请使用 `localhost`。
    - 如果您在 Docker Compose 中运行 PostgreSQL，请使用服务名称，如 `postgres`。
    - 如果您使用 `docker run` 在单独的 Docker 容器中运行 PostgreSQL，请使用容器的 IP 地址或网络别名。
    - 如果您运行云托管的 PostgreSQL，您的提供商将分享您的连接字符串，其中包括用户名和密码。

3. 创建一个 Langflow `.env` 文件：

    ```
    touch .env
    ```

    您可以使用 Langflow 存储库中的 [`.env.example`](https://github.com/langflow-ai/langflow/blob/main/.env.example) 文件作为您自己的 `.env` 文件的模板。

4. 在您的 `.env` 文件中，将 `LANGFLOW_DATABASE_URL` 设置为您的 PostgreSQL 连接字符串：

    ```text
    LANGFLOW_DATABASE_URL="postgresql://user:password@localhost:5432/dbname"
    ```

5. 保存您的更改，然后使用您的 `.env` 文件启动 Langflow：

    ```bash
    uv run langflow run --env-file .env
    ```

6. 在 Langflow 中，运行任何流程以创建流量。

7. 检查您的 PostgreSQL 数据库的表和活动，以验证在您运行流程后创建了新表和流量。

## 使用 docker-compose.yml 部署 Langflow 和 PostgreSQL 容器

在同一个 Docker 网络中启动 Langflow 和 PostgreSQL 容器可以确保服务之间的正常连接。
有关示例，请参阅 Langflow 存储库中的 [`docker-compose.yml`](https://github.com/langflow-ai/langflow/blob/main/docker_example/docker-compose.yml) 文件。

示例 `docker-compose.yml` 中的配置还为 Langflow 和 PostgreSQL 数据设置了持久卷。
持久卷将容器内的目录映射到主机上的存储，因此数据在容器重启时仍然存在。

Docker Compose 为 `docker-compose.yml` 中定义的所有服务创建一个隔离的网络。这确保服务可以使用它们的服务名称作为主机名相互通信，例如数据库 URL 中的 `postgres`。
相比之下，如果您使用 `docker run` 单独运行 PostgreSQL，它会在与 Langflow 容器不同的网络中启动，这会阻止 Langflow 使用服务名称连接到 PostgreSQL。

要使用示例 Docker Compose 文件启动 Langflow 和 PostgreSQL 服务，请导航到 `langflow/docker_example` 目录，然后运行 `docker-compose up`。
如果您使用不同的 `docker-compose.yml` 文件，请从与您的 `docker-compose.yml` 文件相同的目录运行 `docker-compose up` 命令。

## 使用共享 PostgreSQL 数据库部署多个 Langflow 实例

要配置共享同一个 PostgreSQL 数据库的多个 Langflow 实例，请修改您的 `docker-compose.yml` 文件以包含多个 Langflow 服务。

此示例使用您的 Langflow `.env` 文件中的值填充 `docker-compose.yml` 中的值。
这种方法意味着您只需要在一个文件中管理部署变量，而不是在多个文件中复制值。

1. 使用您的 PostgreSQL 数据库的值更新您的 `.env` 文件：

    ```text
    POSTGRES_USER=langflow
    POSTGRES_PASSWORD=your_secure_password
    POSTGRES_DB=langflow
    POSTGRES_HOST=postgres
    POSTGRES_PORT=5432
    LANGFLOW_CONFIG_DIR=app/langflow
    LANGFLOW_PORT_1=7860
    LANGFLOW_PORT_2=7861
    LANGFLOW_HOST=0.0.0.0
    ```
2. 在您的 `docker-compose.yml` 中引用这些变量。
例如：

    ```yaml
    services:
      postgres:
        image: postgres:16
        environment:
          - POSTGRES_USER=${POSTGRES_USER}
          - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          - POSTGRES_DB=${POSTGRES_DB}
        ports:
          - "${POSTGRES_PORT}:5432"
        volumes:
          - langflow-postgres:/var/lib/postgresql/data

      langflow-1:
        image: langflowai/langflow:latest
        pull_policy: always
        ports:
          - "${LANGFLOW_PORT_1}:7860"
        depends_on:
          - postgres
        environment:
          - LANGFLOW_DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
          - LANGFLOW_CONFIG_DIR=${LANGFLOW_CONFIG_DIR}
          - LANGFLOW_HOST=${LANGFLOW_HOST}
          - PORT=7860
        volumes:
          - langflow-data-1:/app/langflow

      langflow-2:
        image: langflowai/langflow:latest
        pull_policy: always
        ports:
          - "${LANGFLOW_PORT_2}:7860"
        depends_on:
          - postgres
        environment:
          - LANGFLOW_DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
          - LANGFLOW_CONFIG_DIR=${LANGFLOW_CONFIG_DIR}
          - LANGFLOW_HOST=${LANGFLOW_HOST}
          - PORT=7860
        volumes:
          - langflow-data-2:/app/langflow

    volumes:
      langflow-postgres:
      langflow-data-1:
      langflow-data-2:
    ```

3. 使用 `docker-compose up` 部署文件。
您可以在 `http://localhost:7860` 访问第一个 Langflow 实例，在 `http://localhost:7861` 访问第二个 Langflow 实例。

4. 要确认两个实例都使用同一个数据库，请运行 `docker exec` 命令在您的 PostgreSQL 容器中启动 `psql`。
您的容器名称可能不同。

    ```bash
    docker exec -it docker-test-postgres-1 psql -U langflow -d langflow
    ```

5. 查询数据库的活动连接：

    ```sql
    langflow=# SELECT * FROM pg_stat_activity WHERE datname = 'langflow';
    ```

6. 检查查询结果中具有不同 `client_addr` 值的多个连接，例如 `172.21.0.3` 和 `172.21.0.4`。
由于每个 Langflow 实例都在 Docker 网络上的自己的容器中运行，使用不同的传入 IP 地址确认了两个实例都积极连接到 PostgreSQL 数据库。

7. 要退出 psql，请输入 `quit`。